  #include "wokwi-api.h"
  #include <stdio.h>
  #include <stdlib.h>
  #include <string.h>    // contains strlen() function

  #define LEN(arr) ((int)(sizeof(arr) / sizeof(arr)[0]))    // macro

  #define SECOND 1000000    // micros

  // A NMEA 0183 sentence can have a maximum of 80 characters plus a
  // carriage return and a line feed

  const char gps_tx_data[][80] = { // GPRMC & GPGGA (Hypothetical Data)
    "$GPGGA,004745.952,1204.426,S,07705.218,W,1,12,1.0,0.0,M,0.0,M,,*64\r\n",
    "$GPGSA,A,3,01,02,03,04,05,06,07,08,09,10,11,12,1.0,1.0,1.0*30\r\n",
    "$GPRMC,004745.952,A,1204.426,S,07705.218,W,038.9,111.6,210624,000.0,W*76\r\n",
    "$GPGGA,004746.952,1204.430,S,07705.208,W,1,12,1.0,0.0,M,0.0,M,,*61\r\n",
    "$GPGSA,A,3,01,02,03,04,05,06,07,08,09,10,11,12,1.0,1.0,1.0*30\r\n",
    "$GPRMC,004746.952,A,1204.430,S,07705.208,W,038.9,111.6,210624,000.0,W*73\r\n",
    "$GPGGA,004747.952,1204.434,S,07705.198,W,1,12,1.0,0.0,M,0.0,M,,*6E\r\n",
    "$GPGSA,A,3,01,02,03,04,05,06,07,08,09,10,11,12,1.0,1.0,1.0*30\r\n",
    "$GPRMC,004747.952,A,1204.434,S,07705.198,W,038.9,111.6,210624,000.0,W*7C\r\n",
    "$GPGGA,004748.952,1204.438,S,07705.187,W,1,12,1.0,0.0,M,0.0,M,,*63\r\n",
    "$GPGSA,A,3,01,02,03,04,05,06,07,08,09,10,11,12,1.0,1.0,1.0*30\r\n",
    "$GPRMC,004748.952,A,1204.438,S,07705.187,W,038.9,111.6,210624,000.0,W*71\r\n",
    "$GPGGA,004749.952,1204.442,S,07705.177,W,1,12,1.0,0.0,M,0.0,M,,*60\r\n",
    "$GPGSA,A,3,01,02,03,04,05,06,07,08,09,10,11,12,1.0,1.0,1.0*30\r\n",
    "$GPRMC,004749.952,A,1204.442,S,07705.177,W,038.9,104.8,210624,000.0,W*78\r\n",
    "$GPGGA,004750.952,1204.445,S,07705.166,W,1,12,1.0,0.0,M,0.0,M,,*6F\r\n",
    "$GPGSA,A,3,01,02,03,04,05,06,07,08,09,10,11,12,1.0,1.0,1.0*30\r\n",
    "$GPRMC,004750.952,A,1204.445,S,07705.166,W,038.9,104.8,210624,000.0,W*77\r\n",
    "$GPGGA,004751.952,1204.448,S,07705.156,W,1,12,1.0,0.0,M,0.0,M,,*60\r\n",
    "$GPGSA,A,3,01,02,03,04,05,06,07,08,09,10,11,12,1.0,1.0,1.0*30\r\n",
    "$GPRMC,004751.952,A,1204.448,S,07705.156,W,038.9,104.8,210624,000.0,W*78\r\n",
    "$GPGGA,004752.952,1204.450,S,07705.145,W,1,12,1.0,0.0,M,0.0,M,,*68\r\n",
    "$GPGSA,A,3,01,02,03,04,05,06,07,08,09,10,11,12,1.0,1.0,1.0*30\r\n",
    "$GPRMC,004752.952,A,1204.450,S,07705.145,W,038.9,104.8,210624,000.0,W*70\r\n",
    "$GPGGA,004753.952,1204.453,S,07705.134,W,1,12,1.0,0.0,M,0.0,M,,*6C\r\n",
    "$GPGSA,A,3,01,02,03,04,05,06,07,08,09,10,11,12,1.0,1.0,1.0*30\r\n",
    "$GPRMC,004753.952,A,1204.453,S,07705.134,W,038.9,104.8,210624,000.0,W*74\r\n",
    "$GPGGA,004754.952,1204.456,S,07705.124,W,1,12,1.0,0.0,M,0.0,M,,*6F\r\n",
    "$GPGSA,A,3,01,02,03,04,05,06,07,08,09,10,11,12,1.0,1.0,1.0*30\r\n",
    "$GPRMC,004754.952,A,1204.456,S,07705.124,W,038.9,104.8,210624,000.0,W*77\r\n",
    "$GPGGA,004755.952,1204.459,S,07705.113,W,1,12,1.0,0.0,M,0.0,M,,*65\r\n",
    "$GPGSA,A,3,01,02,03,04,05,06,07,08,09,10,11,12,1.0,1.0,1.0*30\r\n",
    "$GPRMC,004755.952,A,1204.459,S,07705.113,W,038.9,104.8,210624,000.0,W*7D\r\n",
    "$GPGGA,004756.952,1204.461,S,07705.102,W,1,12,1.0,0.0,M,0.0,M,,*6D\r\n",
    "$GPGSA,A,3,01,02,03,04,05,06,07,08,09,10,11,12,1.0,1.0,1.0*30\r\n",
    "$GPRMC,004756.952,A,1204.461,S,07705.102,W,038.9,104.8,210624,000.0,W*75\r\n",
    "$GPGGA,004757.952,1204.464,S,07705.092,W,1,12,1.0,0.0,M,0.0,M,,*61\r\n",
    "$GPGSA,A,3,01,02,03,04,05,06,07,08,09,10,11,12,1.0,1.0,1.0*30\r\n",
    "$GPRMC,004757.952,A,1204.464,S,07705.092,W,038.9,103.0,210624,000.0,W*76\r\n",
    "$GPGGA,004758.952,1204.467,S,07705.081,W,1,12,1.0,0.0,M,0.0,M,,*6F\r\n",
    "$GPGSA,A,3,01,02,03,04,05,06,07,08,09,10,11,12,1.0,1.0,1.0*30\r\n",
    "$GPRMC,004758.952,A,1204.467,S,07705.081,W,038.9,103.0,210624,000.0,W*78\r\n",
    "$GPGGA,004759.952,1204.469,S,07705.070,W,1,12,1.0,0.0,M,0.0,M,,*6E\r\n",
    "$GPGSA,A,3,01,02,03,04,05,06,07,08,09,10,11,12,1.0,1.0,1.0*30\r\n",
    "$GPRMC,004759.952,A,1204.469,S,07705.070,W,038.9,103.0,210624,000.0,W*79\r\n",
    "$GPGGA,004800.952,1204.471,S,07705.059,W,1,12,1.0,0.0,M,0.0,M,,*6F\r\n",
    "$GPGSA,A,3,01,02,03,04,05,06,07,08,09,10,11,12,1.0,1.0,1.0*30\r\n",
    "$GPRMC,004800.952,A,1204.471,S,07705.059,W,038.9,103.0,210624,000.0,W*78\r\n",
    "$GPGGA,004801.952,1204.474,S,07705.049,W,1,12,1.0,0.0,M,0.0,M,,*6A\r\n",
    "$GPGSA,A,3,01,02,03,04,05,06,07,08,09,10,11,12,1.0,1.0,1.0*30\r\n",
    "$GPRMC,004801.952,A,1204.474,S,07705.049,W,038.9,103.0,210624,000.0,W*7D\r\n",
    "$GPGGA,004802.952,1204.476,S,07705.038,W,1,12,1.0,0.0,M,0.0,M,,*6D\r\n",
    "$GPGSA,A,3,01,02,03,04,05,06,07,08,09,10,11,12,1.0,1.0,1.0*30\r\n",
    "$GPRMC,004802.952,A,1204.476,S,07705.038,W,038.9,097.5,210624,000.0,W*73\r\n",
    "$GPGGA,004803.952,1204.478,S,07705.027,W,1,12,1.0,0.0,M,0.0,M,,*6C\r\n",
    "$GPGSA,A,3,01,02,03,04,05,06,07,08,09,10,11,12,1.0,1.0,1.0*30\r\n",
    "$GPRMC,004803.952,A,1204.478,S,07705.027,W,038.9,097.5,210624,000.0,W*72\r\n",
    "$GPGGA,004804.952,1204.479,S,07705.016,W,1,12,1.0,0.0,M,0.0,M,,*68\r\n",
    "$GPGSA,A,3,01,02,03,04,05,06,07,08,09,10,11,12,1.0,1.0,1.0*30\r\n",
    "$GPRMC,004804.952,A,1204.479,S,07705.016,W,038.9,097.5,210624,000.0,W*76\r\n",
    "$GPGGA,004805.952,1204.481,S,07705.005,W,1,12,1.0,0.0,M,0.0,M,,*6C\r\n",
    "$GPGSA,A,3,01,02,03,04,05,06,07,08,09,10,11,12,1.0,1.0,1.0*30\r\n",
    "$GPRMC,004805.952,A,1204.481,S,07705.005,W,038.9,097.5,210624,000.0,W*72\r\n",
    "$GPGGA,004806.952,1204.482,S,07704.994,W,1,12,1.0,0.0,M,0.0,M,,*6C\r\n",
    "$GPGSA,A,3,01,02,03,04,05,06,07,08,09,10,11,12,1.0,1.0,1.0*30\r\n",
    "$GPRMC,004806.952,A,1204.482,S,07704.994,W,038.9,097.5,210624,000.0,W*72\r\n",
    "$GPGGA,004807.952,1204.483,S,07704.983,W,1,12,1.0,0.0,M,0.0,M,,*6A\r\n",
    "$GPGSA,A,3,01,02,03,04,05,06,07,08,09,10,11,12,1.0,1.0,1.0*30\r\n",
    "$GPRMC,004807.952,A,1204.483,S,07704.983,W,038.9,095.8,210624,000.0,W*7B\r\n",
    "$GPGGA,004808.952,1204.485,S,07704.972,W,1,12,1.0,0.0,M,0.0,M,,*6D\r\n",
    "$GPGSA,A,3,01,02,03,04,05,06,07,08,09,10,11,12,1.0,1.0,1.0*30\r\n",
    "$GPRMC,004808.952,A,1204.485,S,07704.972,W,038.9,095.8,210624,000.0,W*7C\r\n",
    "$GPGGA,004809.952,1204.486,S,07704.961,W,1,12,1.0,0.0,M,0.0,M,,*6D\r\n",
    "$GPGSA,A,3,01,02,03,04,05,06,07,08,09,10,11,12,1.0,1.0,1.0*30\r\n",
    "$GPRMC,004809.952,A,1204.486,S,07704.961,W,038.9,095.8,210624,000.0,W*7C\r\n",
    "$GPGGA,004810.952,1204.487,S,07704.950,W,1,12,1.0,0.0,M,0.0,M,,*66\r\n",
    "$GPGSA,A,3,01,02,03,04,05,06,07,08,09,10,11,12,1.0,1.0,1.0*30\r\n",
    "$GPRMC,004810.952,A,1204.487,S,07704.950,W,038.9,095.8,210624,000.0,W*77\r\n",
  };


  typedef struct {
    uart_dev_t uart0;
    uint32_t   gps_tx_index;
  } chip_state_t;


  static void chip_timer_event  (void *user_data);


  void chip_init(void) {

    setvbuf(stdout, NULL, _IOLBF, 1024);                // ???     // Disable buffering for debug logs

    chip_state_t *chip = malloc(sizeof(chip_state_t));

    const uart_config_t uart_config = {
      .tx         = pin_init("TX", INPUT_PULLUP),
      .rx         = pin_init("RX", INPUT),
      .baud_rate  = 9600,
      .user_data  = chip,
    };

    chip->uart0        = uart_init(&uart_config);
  
    chip->gps_tx_index = 0;

    const timer_config_t timer_config = {
      .callback  = chip_timer_event,
      .user_data = chip,
    };

    timer_t timer = timer_init(&timer_config);

    timer_start(timer, SECOND, true);

    printf("GPS Chip initialized!\n");         // prints to web browser console (developer tools)

  }

  void chip_timer_event(void *user_data) {

    chip_state_t *chip = (chip_state_t*) user_data;

    printf("chip_timer_event\n");
 printf ("LEN(gps_tx_data):  %d\n", LEN(gps_tx_data)   );    // number of messages
// printf ("message length  :  %d\n", strlen(message)    );    // actual message length
printf ("gps_tx_index    :  %u\n", chip->gps_tx_index );    // message index

    const char * message = gps_tx_data[chip->gps_tx_index++];

    uart_write(chip->uart0, (uint8_t *) message, strlen(message));

    if (chip->gps_tx_index >= LEN(gps_tx_data)) {       
      chip->gps_tx_index = 0;
    }
  }

